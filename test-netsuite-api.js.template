/**
 * NetSuite REST API Test Script Template
 *
 * SETUP INSTRUCTIONS:
 * 1. Copy this file to: companies/[COMPANY-NAME]/test-netsuite-api.js
 * 2. Replace all YOUR_* placeholders with your actual NetSuite credentials
 * 3. Get credentials from NetSuite:
 *    - Setup ‚Üí Integrations ‚Üí Manage Integrations ‚Üí New
 *    - Setup ‚Üí Users/Roles ‚Üí Access Tokens ‚Üí New
 *    - Setup ‚Üí Company ‚Üí Company Information (for Account ID)
 *
 * SECURITY WARNING: Never commit this file to Git after adding real credentials!
 */

const crypto = require('crypto');
const https = require('https');

// NetSuite Configuration - REPLACE ALL VALUES BELOW
const config = {
  accountId: 'YOUR_ACCOUNT_ID',           // e.g., '9910981-sb1' or '693183'
  consumerKey: 'YOUR_CONSUMER_KEY',       // From Integration Record
  consumerSecret: 'YOUR_CONSUMER_SECRET', // From Integration Record
  tokenId: 'YOUR_TOKEN_ID',               // From Access Token
  tokenSecret: 'YOUR_TOKEN_SECRET',       // From Access Token
  realm: 'YOUR_REALM'                     // Usually same as accountId or accountId.toUpperCase()
};

/**
 * Generate OAuth 1.0a signature for NetSuite TBA
 */
function generateOAuthHeader(url, method, realm, consumerKey, consumerSecret, tokenId, tokenSecret) {
  const timestamp = Math.floor(Date.now() / 1000).toString();
  const nonce = crypto.randomBytes(16).toString('hex');

  // OAuth parameters
  const oauthParams = {
    oauth_consumer_key: consumerKey,
    oauth_nonce: nonce,
    oauth_signature_method: 'HMAC-SHA256',
    oauth_timestamp: timestamp,
    oauth_token: tokenId,
    oauth_version: '1.0'
  };

  // Build signature base string
  const paramString = Object.keys(oauthParams)
    .sort()
    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(oauthParams[key])}`)
    .join('&');

  const signatureBaseString = `${method.toUpperCase()}&${encodeURIComponent(url)}&${encodeURIComponent(paramString)}`;

  // Generate signature
  const signingKey = `${encodeURIComponent(consumerSecret)}&${encodeURIComponent(tokenSecret)}`;
  const signature = crypto
    .createHmac('sha256', signingKey)
    .update(signatureBaseString)
    .digest('base64');

  // Build OAuth header
  const authHeader = `OAuth realm="${realm}", ` +
    Object.keys(oauthParams)
      .map(key => `${key}="${encodeURIComponent(oauthParams[key])}"`)
      .join(', ') +
    `, oauth_signature="${encodeURIComponent(signature)}"`;

  return authHeader;
}

/**
 * Execute SuiteQL query via REST API
 */
function executeSuiteQL(query) {
  return new Promise((resolve, reject) => {
    const url = `https://${config.accountId}.suitetalk.api.netsuite.com/services/rest/query/v1/suiteql`;
    const method = 'POST';
    const body = JSON.stringify({ q: query });

    const authHeader = generateOAuthHeader(
      url,
      method,
      config.realm,
      config.consumerKey,
      config.consumerSecret,
      config.tokenId,
      config.tokenSecret
    );

    const options = {
      hostname: `${config.accountId}.suitetalk.api.netsuite.com`,
      path: '/services/rest/query/v1/suiteql',
      method: method,
      headers: {
        'Authorization': authHeader,
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(body),
        'Prefer': 'transient'
      }
    };

    console.log('Making request to:', url);

    const req = https.request(options, (res) => {
      let data = '';

      console.log('Response status:', res.statusCode);

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        try {
          const parsed = JSON.parse(data);
          resolve({ statusCode: res.statusCode, data: parsed });
        } catch (e) {
          resolve({ statusCode: res.statusCode, data: data });
        }
      });
    });

    req.on('error', (error) => {
      reject(error);
    });

    req.write(body);
    req.end();
  });
}

// Test the connection
console.log('Testing NetSuite REST API Connection...');
console.log('Account ID:', config.accountId);
console.log('');

executeSuiteQL('SELECT id, entityid, companyname FROM customer WHERE isinactive = \'F\' FETCH FIRST 5 ROWS ONLY')
  .then(result => {
    console.log('\n‚úÖ SUCCESS!');
    console.log('Status Code:', result.statusCode);
    console.log('\nResponse Data:');
    console.log(JSON.stringify(result.data, null, 2));

    if (result.data.items) {
      console.log('\nüìä Retrieved', result.data.items.length, 'customers:');
      result.data.items.forEach(item => {
        console.log(`  - ID: ${item.id}, Entity ID: ${item.entityid}, Company: ${item.companyname || 'N/A'}`);
      });
    }
  })
  .catch(error => {
    console.error('\n‚ùå ERROR:', error.message);
    console.error(error);
  });
